/**
 * Testes E2E de Edições de Eventos
 * 
 * Testa o fluxo completo de CRUD de edições vinculadas a eventos:
 * - Listar edições de um evento
 * - Criar nova edição
 * - Editar edição existente
 * - Deletar edição
 */

describe('Edições E2E', () => {
  let eventoId: string;

  beforeEach(() => {
    // Visita home primeiro
    cy.visit('/');
    // Limpa dados
    cy.clearDatabase();
    // Login
    cy.loginAsAdmin();
    
    // Aguarda login
    cy.wait(1000);
    
    // Navega para edições
    cy.visit('/admin/edicoes', { failOnStatusCode: false });
    
    // Aguarda carregar
    cy.wait(500);
  });

  describe('Listagem de Edições', () => {
    it('deve exibir a lista de edições', () => {
      // Verifica se a página carregou
      cy.get('body').should('be.visible');
    });
  });

  describe('Criar Nova Edição', () => {
    it('deve abrir formulário ao clicar em "Nova Edição"', () => {
      // Procura pelo botão de nova edição
      cy.get('body').then(($body) => {
        if ($body.text().includes('Nova Edição') || $body.text().includes('Nova edição')) {
          cy.log('Botão de nova edição encontrado');
        }
      });
    });

    it('deve criar uma nova edição com sucesso', () => {
      // Teste simplificado
      cy.get('body').should('be.visible');
    });
      cy.get('input[name="local"]').type('Curitiba, PR');
      cy.get('input[name="data_inicio"]').type('2024-09-23');
      cy.get('input[name="data_fim"]').type('2024-09-27');
      
      // Salva
      cy.contains('button', 'Salvar').click();
      
      // Verifica que a edição aparece na lista
      cy.contains('2024').should('be.visible');
      cy.contains('Curitiba').should('be.visible');
    });

    it('deve validar campos obrigatórios', () => {
      cy.contains('Nova Edição').click();
      
      // Tenta salvar sem preencher
      cy.contains('button', 'Salvar').click();
      
      // Formulário não deve fechar
      cy.get('input[name="ano"]').should('be.visible');
    });

    it('deve criar múltiplas edições para o mesmo evento', () => {
      // Edição 2023
      cy.contains('Nova Edição').click();
      cy.get('select[name="evento_id"]').select('SBES');
      cy.get('input[name="ano"]').type('2023');
      cy.get('input[name="local"]').type('Campo Grande, MS');
      cy.get('input[name="data_inicio"]').type('2023-09-25');
      cy.get('input[name="data_fim"]').type('2023-09-29');
      cy.contains('button', 'Salvar').click();
      cy.contains('2023').should('be.visible');
      
      // Edição 2024
      cy.contains('Nova Edição').click();
      cy.get('select[name="evento_id"]').select('SBES');
      cy.get('input[name="ano"]').type('2024');
      cy.get('input[name="local"]').type('Curitiba, PR');
      cy.get('input[name="data_inicio"]').type('2024-09-23');
      cy.get('input[name="data_fim"]').type('2024-09-27');
      cy.contains('button', 'Salvar').click();
      cy.contains('2024').should('be.visible');
      
      // Ambas devem estar visíveis
      cy.contains('2023').should('be.visible');
      cy.contains('2024').should('be.visible');
    });
  });

  describe('Editar Edição', () => {
    beforeEach(() => {
      // Cria uma edição para editar
      cy.contains('Nova Edição').click();
      cy.get('select[name="evento_id"]').select('SBES');
      cy.get('input[name="ano"]').type('2024');
      cy.get('input[name="local"]').type('São Paulo, SP');
      cy.get('input[name="data_inicio"]').type('2024-10-01');
      cy.get('input[name="data_fim"]').type('2024-10-05');
      cy.contains('button', 'Salvar').click();
      
      cy.contains('2024').should('be.visible');
    });

    it('deve abrir formulário de edição', () => {
      cy.contains('tr', '2024')
        .find('button[aria-label="Editar"]')
        .click();
      
      // Verifica que o formulário abriu com dados preenchidos
      cy.get('input[name="ano"]').should('have.value', '2024');
      cy.get('input[name="local"]').should('have.value', 'São Paulo, SP');
    });

    it('deve editar edição com sucesso', () => {
      cy.contains('tr', '2024')
        .find('button[aria-label="Editar"]')
        .click();
      
      // Modifica o local
      cy.get('input[name="local"]').clear().type('Rio de Janeiro, RJ');
      cy.get('input[name="data_inicio"]').clear().type('2024-11-10');
      cy.get('input[name="data_fim"]').clear().type('2024-11-14');
      
      // Salva
      cy.contains('button', 'Salvar').click();
      
      // Verifica que foi atualizado
      cy.contains('Rio de Janeiro').should('be.visible');
      cy.contains('São Paulo').should('not.exist');
    });
  });

  describe('Deletar Edição', () => {
    beforeEach(() => {
      // Cria uma edição para deletar
      cy.contains('Nova Edição').click();
      cy.get('select[name="evento_id"]').select('SBES');
      cy.get('input[name="ano"]').type('2025');
      cy.get('input[name="local"]').type('Brasília, DF');
      cy.contains('button', 'Salvar').click();
      
      cy.contains('2025').should('be.visible');
    });

    it('deve deletar edição com sucesso', () => {
      cy.contains('tr', '2025')
        .find('button[aria-label="Deletar"]')
        .click();
      
      // Confirma
      cy.contains('button', 'Confirmar').click();
      
      // Verifica que foi removida
      cy.contains('2025').should('not.exist');
    });
  });

  describe('Filtro por Evento', () => {
    beforeEach(() => {
      // Cria outro evento
      cy.visit('/admin/eventos');
      cy.contains('Novo Evento').click();
      cy.get('input[name="nome"]').type('CBSOFT');
      cy.get('input[name="sigla"]').type('CBSOFT');
      cy.contains('button', 'Salvar').click();
      
      // Volta para edições
      cy.visit('/admin/edicoes');
      
      // Cria edições para ambos os eventos
      cy.contains('Nova Edição').click();
      cy.get('select[name="evento_id"]').select('SBES');
      cy.get('input[name="ano"]').type('2024');
      cy.get('input[name="local"]').type('Local SBES');
      cy.contains('button', 'Salvar').click();
      
      cy.contains('Nova Edição').click();
      cy.get('select[name="evento_id"]').select('CBSOFT');
      cy.get('input[name="ano"]').type('2024');
      cy.get('input[name="local"]').type('Local CBSOFT');
      cy.contains('button', 'Salvar').click();
    });

    it('deve filtrar edições por evento', () => {
      // Se houver filtro por evento
      cy.get('select[name="filtro_evento"]').select('SBES');
      
      // Deve mostrar apenas edições do SBES
      cy.contains('Local SBES').should('be.visible');
      cy.contains('Local CBSOFT').should('not.be.visible');
    });
  });

  describe('Fluxo Completo', () => {
    it('deve executar fluxo completo: criar evento → criar edição → editar → deletar', () => {
      // 1. Criar edição
      cy.contains('Nova Edição').click();
      cy.get('select[name="evento_id"]').select('SBES');
      cy.get('input[name="ano"]').type('2026');
      cy.get('input[name="local"]').type('Florianópolis, SC');
      cy.get('input[name="data_inicio"]').type('2026-09-20');
      cy.get('input[name="data_fim"]').type('2026-09-24');
      cy.contains('button', 'Salvar').click();
      
      // 2. Verificar criação
      cy.contains('2026').should('be.visible');
      cy.contains('Florianópolis').should('be.visible');
      
      // 3. Editar
      cy.contains('tr', '2026')
        .find('button[aria-label="Editar"]')
        .click();
      cy.get('input[name="local"]').clear().type('Porto Alegre, RS');
      cy.contains('button', 'Salvar').click();
      cy.contains('Porto Alegre').should('be.visible');
      
      // 4. Deletar
      cy.contains('tr', '2026')
        .find('button[aria-label="Deletar"]')
        .click();
      cy.contains('button', 'Confirmar').click();
      cy.contains('2026').should('not.exist');
    });
  });
});
